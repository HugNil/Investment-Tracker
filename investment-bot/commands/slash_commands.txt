import discord
from discord import app_commands
from db.database import add_position, sell_position, get_active_positions, get_sold_positions


class InvestmentCommands(discord.ext.commands.Cog):
    def __init__(self, bot):
        self.bot = bot

    # Autocomplete för aktienamn
    async def aktie_autocomplete(self, interaction: discord.Interaction, current: str):
        aktier = ["Marathon Digital", "Tesla", "Apple", "Microsoft", "Cipher Mining"]
        return [app_commands.Choice(name=aktie, value=aktie) for aktie in aktier if current.lower() in aktie.lower()]

    # Autocomplete för risknivå
    async def risknivå_autocomplete(self, interaction: discord.Interaction, current: str):
        nivaer = ["High", "Medium", "Low"]
        return [app_commands.Choice(name=niva, value=niva) for niva in nivaer if current.lower() in niva.lower()]

    # Slash-kommando för att registrera köp
    @app_commands.command(name="köp", description="Registrera en köp-signal.")
    @app_commands.describe(
        aktie="Namnet på aktien",
        gav="Genomsnittligt anskaffningsvärde",
        stoploss="Stop-loss-värde (valfritt)",
        risknivå="Risknivå (valfritt)"
    )
    @app_commands.autocomplete(aktie=aktie_autocomplete, risknivå=risknivå_autocomplete)
    async def köp(self, interaction: discord.Interaction, aktie: str, gav: float, stoploss: float = None, risknivå: str = None):
        try:
            add_position(aktie, gav, stoploss, risknivå)
            await interaction.response.send_message(
                f"Köp registrerat för '{aktie}' med GAV {gav}, stop-loss {stoploss or 'Ej angivet'}, risknivå {risknivå or 'Ej angivet'}."
            )
        except Exception as e:
            await interaction.response.send_message(f"Fel vid registrering: {e}", ephemeral=True)

    # Slash-kommando för att sälja
    @app_commands.command(name="sälj", description="Markera en position som såld.")
    @app_commands.describe(
        id="ID för positionen som ska säljas",
        pris="Säljpriset"
    )
    async def sälj(self, interaction: discord.Interaction, id: int, pris: float):
        try:
            aktie, resultat = sell_position(id, price=pris)
            if aktie:
                await interaction.response.send_message(f"Sålde {aktie} med resultat {resultat:.2f}%.")
            else:
                await interaction.response.send_message("Ingen aktiv position hittades med det ID:t.", ephemeral=True)
        except Exception as e:
            await interaction.response.send_message(f"Fel vid säljning: {e}", ephemeral=True)

    # Slash-kommando för att visa aktiva positioner
    @app_commands.command(name="aktiva", description="Visa alla aktiva positioner.")
    async def aktiva(self, interaction: discord.Interaction):
        positions = get_active_positions()
        if positions:
            # Skapa rubriken med monospace-format
            response = "```"  # Starta kodblock
            response += "Aktiva positioner:\n\n"
            response += f"{'Aktie':<30} | {'GAV':<10} | {'Stop-loss':<10} | {'Risknivå':<10} | {'Köpt':<15}\n"
            response += f"{'-'*30} | {'-'*10} | {'-'*10} | {'-'*10} | {'-'*15}\n"

            for pos in positions:
                response += f"{pos[3]:<30} | {pos[4]:<10.2f} | {pos[6] or 'Ej angivet':<10} | {pos[7] or 'Ej angivet':<10} | {pos[1]:<15}\n"

            response += "```"  # Avsluta kodblock
            await interaction.response.send_message(response)
        else:
            await interaction.response.send_message("Inga aktiva positioner just nu.")

    # Slash-kommando för att visa avslutade positioner
    @app_commands.command(name="avslutade", description="Visa alla avslutade positioner.")
    async def avslutade(self, interaction: discord.Interaction):
        positions = get_sold_positions()
        if positions:
            total_result = 0  # Variabel för att summera resultatet

            # Skapa rubriken med monospace-format
            response = "```\n"  # Starta kodblock
            response += "Avslutade positioner:\n\n"
            response += f"{'Aktie':<30} | {'GAV':<8} | {'Såld':<8} | {'Resultat':<10} | {'Köpt':<12} | {'Såld':<12}\n"
            response += f"{'-'*30} | {'-'*8} | {'-'*8} | {'-'*10} | {'-'*12} | {'-'*12}\n"

            for pos in positions:
                total_result += pos[9]  # Lägg till resultatet för varje position
                response += f"{pos[3]:<30} | {pos[4]:<8.2f} | {pos[5]:<8.2f} | {pos[9]:<10.2f}%| {pos[1]:<12} | {pos[2]:<12}\n"

            # Lägg till totalen i meddelandet
            response += f"\n{'Totalt resultat:':<30}   {total_result:.2f}%\n"
            response += "```"  # Avsluta kodblock
            await interaction.response.send_message(response)
        else:
            await interaction.response.send_message("Inga avslutade positioner hittades.")

